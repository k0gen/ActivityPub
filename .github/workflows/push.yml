name: Push

on:
  workflow_call:
    inputs:
      activitypub-public-tags:
        description: ActivityPub Docker image tags for public registry
        required: false
        type: string
      activitypub-public-labels:
        description: ActivityPub Docker image labels for public registry
        required: false
        type: string
      activitypub-migrations-public-tags:
        description: ActivityPub Migrations Docker image tags for public registry
        required: false
        type: string
      activitypub-migrations-public-labels:
        description: ActivityPub Migrations Docker image labels for public registry
        required: false
        type: string

permissions:
  contents: read
  packages: write

jobs:
  push-main-images:
    name: Push Docker Images to GHCR
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Download ActivityPub amd64 image
        uses: actions/download-artifact@v4
        with:
          name: activitypub-amd64
          path: /tmp
          continue-on-error: true

      - name: Download ActivityPub arm64 image
        uses: actions/download-artifact@v4
        with:
          name: activitypub-arm64
          path: /tmp
          continue-on-error: true

      - name: Download Migrations amd64 image
        uses: actions/download-artifact@v4
        with:
          name: activitypub-migrations-amd64
          path: /tmp
          continue-on-error: true

      - name: Download Migrations arm64 image
        uses: actions/download-artifact@v4
        with:
          name: activitypub-migrations-arm64
          path: /tmp
          continue-on-error: true

      - name: Push ActivityPub Docker image to GHCR (multi-arch)
        if: inputs.activitypub-public-tags != ''
        run: |
          # Load images and find their tags
          HAS_AMD64=false
          HAS_ARM64=false
          AMD64_SOURCE_TAG=""
          ARM64_SOURCE_TAG=""
          
          if [ -f /tmp/activitypub-amd64.tar ]; then
            docker load < /tmp/activitypub-amd64.tar
            HAS_AMD64=true
            # Find the loaded image tag (should match one of our public tags)
            FIRST_PUBLIC_TAG=$(echo "${{ inputs.activitypub-public-tags }}" | head -n1 | tr -d ' ')
            BASE_IMAGE=$(echo "$FIRST_PUBLIC_TAG" | cut -d: -f1)
            AMD64_SOURCE_TAG=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "^${BASE_IMAGE}" | head -n1)
            if [ -z "$AMD64_SOURCE_TAG" ]; then
              # Fallback: use first loaded image
              AMD64_SOURCE_TAG=$(docker images --format "{{.Repository}}:{{.Tag}}" | head -n1)
            fi
          fi
          
          if [ -f /tmp/activitypub-arm64.tar ]; then
            docker load < /tmp/activitypub-arm64.tar
            HAS_ARM64=true
            # Find the loaded image tag
            FIRST_PUBLIC_TAG=$(echo "${{ inputs.activitypub-public-tags }}" | head -n1 | tr -d ' ')
            BASE_IMAGE=$(echo "$FIRST_PUBLIC_TAG" | cut -d: -f1)
            ARM64_SOURCE_TAG=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "^${BASE_IMAGE}" | head -n1)
            if [ -z "$ARM64_SOURCE_TAG" ]; then
              # Fallback: use first loaded image
              ARM64_SOURCE_TAG=$(docker images --format "{{.Repository}}:{{.Tag}}" | head -n1)
            fi
          fi
          
          # Get the base image name from the first public tag
          FIRST_TAG=$(echo "${{ inputs.activitypub-public-tags }}" | head -n1 | tr -d ' ')
          if [ -z "$FIRST_TAG" ]; then
            echo "No public tags found, skipping push"
            exit 0
          fi
          
          # Extract base image name (e.g., ghcr.io/owner/repo:1.0.0 -> ghcr.io/owner/repo)
          BASE_IMAGE=$(echo "$FIRST_TAG" | cut -d: -f1)
          
          # Push platform-specific images first
          if [ "$HAS_AMD64" = true ] && [ -n "$AMD64_SOURCE_TAG" ]; then
            echo "${{ inputs.activitypub-public-tags }}" | while read -r tag; do
              if [ -n "$tag" ]; then
                VERSION=$(echo "$tag" | cut -d: -f2)
                AMD64_TAG="${BASE_IMAGE}:amd64-${VERSION}"
                docker tag "$AMD64_SOURCE_TAG" "$AMD64_TAG"
                docker push "$AMD64_TAG"
              fi
            done
          fi
          
          if [ "$HAS_ARM64" = true ] && [ -n "$ARM64_SOURCE_TAG" ]; then
            echo "${{ inputs.activitypub-public-tags }}" | while read -r tag; do
              if [ -n "$tag" ]; then
                VERSION=$(echo "$tag" | cut -d: -f2)
                ARM64_TAG="${BASE_IMAGE}:arm64-${VERSION}"
                docker tag "$ARM64_SOURCE_TAG" "$ARM64_TAG"
                docker push "$ARM64_TAG"
              fi
            done
          fi
          
          # Create and push multi-arch manifest if we have both architectures
          if [ "$HAS_AMD64" = true ] && [ "$HAS_ARM64" = true ]; then
            echo "${{ inputs.activitypub-public-tags }}" | while read -r tag; do
              if [ -n "$tag" ]; then
                VERSION=$(echo "$tag" | cut -d: -f2)
                docker manifest create "$tag" \
                  "${BASE_IMAGE}:amd64-${VERSION}" \
                  "${BASE_IMAGE}:arm64-${VERSION}" || true
                docker manifest annotate "$tag" "${BASE_IMAGE}:amd64-${VERSION}" --arch amd64 || true
                docker manifest annotate "$tag" "${BASE_IMAGE}:arm64-${VERSION}" --arch arm64 || true
                docker manifest push "$tag"
              fi
            done
          elif [ "$HAS_AMD64" = true ]; then
            # Only amd64 available, push single-arch
            echo "${{ inputs.activitypub-public-tags }}" | while read -r tag; do
              if [ -n "$tag" ] && [ -n "$AMD64_SOURCE_TAG" ]; then
                docker tag "$AMD64_SOURCE_TAG" "$tag"
                docker push "$tag"
              fi
            done
          elif [ "$HAS_ARM64" = true ]; then
            # Only arm64 available, push single-arch
            echo "${{ inputs.activitypub-public-tags }}" | while read -r tag; do
              if [ -n "$tag" ] && [ -n "$ARM64_SOURCE_TAG" ]; then
                docker tag "$ARM64_SOURCE_TAG" "$tag"
                docker push "$tag"
              fi
            done
          fi

      - name: Push Migrations Docker image to GHCR (multi-arch)
        if: inputs.activitypub-migrations-public-tags != ''
        run: |
          # Load images and find their tags
          HAS_AMD64=false
          HAS_ARM64=false
          AMD64_SOURCE_TAG=""
          ARM64_SOURCE_TAG=""
          
          if [ -f /tmp/activitypub-migrations-amd64.tar ]; then
            docker load < /tmp/activitypub-migrations-amd64.tar
            HAS_AMD64=true
            # Find the loaded image tag
            FIRST_PUBLIC_TAG=$(echo "${{ inputs.activitypub-migrations-public-tags }}" | head -n1 | tr -d ' ')
            BASE_IMAGE=$(echo "$FIRST_PUBLIC_TAG" | cut -d: -f1)
            AMD64_SOURCE_TAG=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "^${BASE_IMAGE}" | head -n1)
            if [ -z "$AMD64_SOURCE_TAG" ]; then
              # Fallback: use first loaded image
              AMD64_SOURCE_TAG=$(docker images --format "{{.Repository}}:{{.Tag}}" | head -n1)
            fi
          fi
          
          if [ -f /tmp/activitypub-migrations-arm64.tar ]; then
            docker load < /tmp/activitypub-migrations-arm64.tar
            HAS_ARM64=true
            # Find the loaded image tag
            FIRST_PUBLIC_TAG=$(echo "${{ inputs.activitypub-migrations-public-tags }}" | head -n1 | tr -d ' ')
            BASE_IMAGE=$(echo "$FIRST_PUBLIC_TAG" | cut -d: -f1)
            ARM64_SOURCE_TAG=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "^${BASE_IMAGE}" | head -n1)
            if [ -z "$ARM64_SOURCE_TAG" ]; then
              # Fallback: use first loaded image
              ARM64_SOURCE_TAG=$(docker images --format "{{.Repository}}:{{.Tag}}" | head -n1)
            fi
          fi
          
          # Get the base image name from the first public tag
          FIRST_TAG=$(echo "${{ inputs.activitypub-migrations-public-tags }}" | head -n1 | tr -d ' ')
          if [ -z "$FIRST_TAG" ]; then
            echo "No public tags found, skipping push"
            exit 0
          fi
          
          # Extract base image name
          BASE_IMAGE=$(echo "$FIRST_TAG" | cut -d: -f1)
          
          # Push platform-specific images first
          if [ "$HAS_AMD64" = true ] && [ -n "$AMD64_SOURCE_TAG" ]; then
            echo "${{ inputs.activitypub-migrations-public-tags }}" | while read -r tag; do
              if [ -n "$tag" ]; then
                VERSION=$(echo "$tag" | cut -d: -f2)
                AMD64_TAG="${BASE_IMAGE}:amd64-${VERSION}"
                docker tag "$AMD64_SOURCE_TAG" "$AMD64_TAG"
                docker push "$AMD64_TAG"
              fi
            done
          fi
          
          if [ "$HAS_ARM64" = true ] && [ -n "$ARM64_SOURCE_TAG" ]; then
            echo "${{ inputs.activitypub-migrations-public-tags }}" | while read -r tag; do
              if [ -n "$tag" ]; then
                VERSION=$(echo "$tag" | cut -d: -f2)
                ARM64_TAG="${BASE_IMAGE}:arm64-${VERSION}"
                docker tag "$ARM64_SOURCE_TAG" "$ARM64_TAG"
                docker push "$ARM64_TAG"
              fi
            done
          fi
          
          # Create and push multi-arch manifest if we have both architectures
          if [ "$HAS_AMD64" = true ] && [ "$HAS_ARM64" = true ]; then
            echo "${{ inputs.activitypub-migrations-public-tags }}" | while read -r tag; do
              if [ -n "$tag" ]; then
                VERSION=$(echo "$tag" | cut -d: -f2)
                docker manifest create "$tag" \
                  "${BASE_IMAGE}:amd64-${VERSION}" \
                  "${BASE_IMAGE}:arm64-${VERSION}" || true
                docker manifest annotate "$tag" "${BASE_IMAGE}:amd64-${VERSION}" --arch amd64 || true
                docker manifest annotate "$tag" "${BASE_IMAGE}:arm64-${VERSION}" --arch arm64 || true
                docker manifest push "$tag"
              fi
            done
          elif [ "$HAS_AMD64" = true ]; then
            # Only amd64 available, push single-arch
            echo "${{ inputs.activitypub-migrations-public-tags }}" | while read -r tag; do
              if [ -n "$tag" ] && [ -n "$AMD64_SOURCE_TAG" ]; then
                docker tag "$AMD64_SOURCE_TAG" "$tag"
                docker push "$tag"
              fi
            done
          elif [ "$HAS_ARM64" = true ]; then
            # Only arm64 available, push single-arch
            echo "${{ inputs.activitypub-migrations-public-tags }}" | while read -r tag; do
              if [ -n "$tag" ] && [ -n "$ARM64_SOURCE_TAG" ]; then
                docker tag "$ARM64_SOURCE_TAG" "$tag"
                docker push "$tag"
              fi
            done
          fi
